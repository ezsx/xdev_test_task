
# Сервис FastAPI для работы с грибами и корзинками

Данный проект представляет собой сервис, реализованный на базе FastAPI, для управления двумя основными сущностями: грибами и корзинками. Проект был выполнен как тестовое задание и соответствует следующим требованиям:

- **Грибы:**  
  Каждый гриб имеет следующие характеристики:  
  - `id` (UUID)  
  - `name` (название)  
  - `edible` (булевое значение: съедобный или нет)  
  - `weight` (вес в граммах)  
  - `fresh` (булевое значение: свежий или нет)

- **Корзинки:**  
  Каждая корзинка имеет:  
  - `id` (UUID)  
  - `owner` (имя владельца)  
  - `capacity` (вместимость в граммах)  
  - `mushrooms` – список грибов, добавленных в корзинку  
  Между корзинками и грибами реализована связь «многие ко многим» через вспомогательную таблицу.

---

## Обзор архитектуры и ключевых компонентов

### Технологии и инструменты

- **FastAPI:**  
  Основной фреймворк для создания REST API. Все эндпоинты доступны из документации при запуске http://localhost:8000/store/api/openapi .

- **База данных и миграции:**  
  Используется PostgreSQL в качестве основного хранилища данных. ORM реализована с помощью SQLAlchemy с асинхронными сессиями, а миграции схемы базы данных выполняются с помощью Alembic.

- **Кэширование:**  
  Для ускорения чтения данных интегрирован Redis. GET-запросы к API кэшируются, а при изменении данных соответствующие кэш-ключи инвалидируются.

- **Контейнеризация и оркестрация:**  
  Проект контейнеризован с использованием Docker и Docker Compose. В состав проекта входят контейнеры для FastAPI, PostgreSQL, Redis и NGINX (который обеспечивает базовую защиту от DDoS-атак).

- **Валидация и настройки:**  
  Валидация входящих и исходящих данных выполняется с помощью Pydantic и pydantic-settings. Конфигурация проекта управляется через файл `.env` и класс настроек.

- **Тестирование:**  
  Тестирование реализовано с использованием `pytest`, `pytest-asyncio` и `httpx.AsyncClient`. Функциональные тесты разделены на файлы для грибов и корзинок. Общие фикстуры для создания сущностей вынесены в отдельные модули в папке `fixtures`, чтобы избежать дублирования кода.

- **Качество кода:**  
  Для контроля качества кода используются линтеры `wemakestuleguid` и `flake8`, которые настроены на автоматический запуск при пуше в GitHub.
  Для запуска линтера можно использовать:
  ```
  pip install wemake-python-styleguide flake8-html
  flake8 . --format=html --htmldir=flake-report
  ```

---

## Структура проекта

```
.
├── src
│   ├── api
│   │   ├── v1
│   │       ├── mushrooms.py         # Эндпоинты для работы с грибами
│   │       └── baskets.py           # Эндпоинты для работы с корзинками
│   │   └── routers.py               # Роутер
│   ├── core
│   │   ├── config.py                # Конфигурация приложения и настройки
│   │   └── logging.py               # Расширенное логирование
│   ├── db
│   │   ├── models_base.py           # Базовый класс для SQLAlchemy-моделей
│   │   ├── postgres.py              # Управление подключением к базе данных и сессиями
│   │   ├── base.py                  # Абстрактный сервис
│   │   └── redis_db.py              # Подключение к redis
│   ├── migrations
│   │   ├── versions                 # Директория миграций Alembic
│   │       └── initial_migration.py # Стартовая миграция
│   │   ├── env.py                   # Подключеие моделей для миграции
│   │   └── script.py.mako           # Конфиг миграций
│   ├── models
│   │   ├── mushroom.py              # Модель гриба (SQLAlchemy)
│   │   ├── basket.py                # Модель корзинки (SQLAlchemy)
│   │   └── basket_mushrooms.py      # Таблица связей для корзинок и грибов
│   ├── schemas
│   │   ├── mushroom.py              # Схемы Pydantic для грибов
│   │   └── basket.py                # Схемы Pydantic для корзинок
│   ├── services
│   │   ├── mushroom_service.py      # Бизнес-логика для работы с грибами
│   │   ├── basket_service.py        # Бизнес-логика для работы с корзинками (с поддержкой кэширования)
│   │   ├── interfaces.py            # Интерфейсы для кеш сервисов
│   │   └── cache.py                 # Кэш сервис
│   ├── main.py                      # Точка входа для FastAPI приложения
│   ├── Dockerfile                   # Dockerfile для сборки FastAPI-сервиса
│   └── ....
├── tests
│   ├── conftest.py                  # Глобальная конфигурация тестов (только объявление плагинов)
│   ├── fixtures
│   │   ├── mush_fixtures.py         # Фикстуры для создания грибов
│   │   └── basket_fixtures.py       # Фикстуры для создания корзинок и управления ими
│   └── src
│       ├── test_mush.py             # Функциональные тесты для эндпоинтов грибов
│       └── test_basket.py           # Функциональные тесты для эндпоинтов корзинок
│   ├── Dockerfile                   # Dockerfile для сборки Тестов
│   └── ....
├── docker-services-mush.yml         # Объявление сервисов с профилем для тестов
├── docker-compose-mush.yml          # Docker Compose для поднятия всех необходимых контейнеров
├── requirements.txt                 # Зависимости Python-проектов
├── settings.py                      # Настройки для тестовой среды (DB, Redis, URL сервиса и т.д.)
├── start.ps1                        # PowerShell-скрипт для запуска основных сервисов (с тестовым профилем)
├── stop.ps1                         # PowerShell-скрипт для остановки основных сервисов (с тестовым профилем)
├── README.md                        # Этот файл README
└── ...
```

---

## Инструкции по запуску проекта

### Запуск основных сервисов

Для поднятия всех необходимых сервисов (FastAPI, PostgreSQL, Redis, NGINX) используется Docker Compose с профилированием для тестового режима. В директории проекта приведены скрипты для запуска на Win и Linux: 
- [start-all-win.ps1](start-all-win.ps1) 
- [start-all.sh](start-all.sh)

(не забыть убрать .example)

- [.env.example](.env.example)
- [mush-service/.env.example](mush-service/.env.example)

---


## Заключение

В данном проекте реализован сервис на FastAPI для работы с грибами и корзинками, который включает:
- Чёткое разделение бизнес-логики с использованием сервисного слоя и DI.
- Интеграцию с PostgreSQL (с миграциями через Alembic) и Redis (для кэширования GET-запросов).
- Контейнеризацию с использованием Docker и Docker Compose.
- Покрытие функциональными тестами с использованием `pytest-asyncio` и модульными фикстурами.
- Поддержку автоматизированного контроля качества кода через линтеры (`wemakestuleguid` и `flake8`).

---

## Что можно было сделать еще?

- Пагинация выдачи списка грибов внутри корзинок
- Провести нагрузочное тестирование замерить RPS
- Если сервис предполагает большую нагрузку на чтение, можно рассмотреть ETL пайплайны для переноса данных в ES или ClickHouse
- Если уверены что ничего менять не будем, добавить модульные тесты
- Можно добавить метрики в grafana
- Вместо одного инстанса Postgre развернуть кластер